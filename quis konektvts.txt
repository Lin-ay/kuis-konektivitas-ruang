<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tarik Tambang SMK: Campuran Topik IPAS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --p1-color: #00d2ff;
            --p2-color: #ff416c;
        }

        body {
            font-family: 'Rajdhani', sans-serif;
            background: #020205;
            color: white;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            margin: 0;
            overflow: hidden;
            touch-action: manipulation;
        }

        h1, h2, h3 { font-family: 'Orbitron', sans-serif; }

        .global-header {
            background: rgba(0,0,0,0.8);
            border-bottom: 1px solid rgba(0, 210, 255, 0.3);
            padding: 8px;
            z-index: 100;
            text-align: center;
            flex-shrink: 0;
        }

        .cyber-card {
            background: rgba(10, 10, 20, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            border-radius: 16px;
            box-shadow: 0 0 40px rgba(0,0,0,0.7);
        }

        .rope-container {
            position: relative;
            width: 100%;
            height: 24px;
            background: #111;
            border-radius: 12px;
            overflow: hidden;
            border: 2px solid rgba(255,255,255,0.1);
            flex-shrink: 0;
        }

        #rope-marker {
            position: absolute;
            top: 0;
            left: 50%;
            width: 8px;
            height: 100%;
            background: #fff;
            box-shadow: 0 0 20px #fff;
            z-index: 20;
            transition: left 0.6s cubic-bezier(0.23, 1, 0.32, 1);
        }

        .p1-side { background: linear-gradient(to right, #00d2ff, #004e92); height: 100%; position: absolute; left: 0; transition: width 0.6s ease; }
        .p2-side { background: linear-gradient(to left, #ff416c, #ff4b2b); height: 100%; position: absolute; right: 0; transition: width 0.6s ease; }

        .choice-btn {
            transition: all 0.2s;
            border: 1px solid rgba(255,255,255,0.15);
            background: rgba(255,255,255,0.05);
            font-size: 0.85rem;
            padding: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 48px;
            width: 100%;
            text-align: center;
            border-radius: 10px;
        }

        .player-active-p1 {
            background: rgba(0, 210, 255, 0.3) !important;
            border-color: #00d2ff !important;
            box-shadow: 0 0 20px rgba(0, 210, 255, 0.5);
            animation: glow-p1 1.5s infinite alternate;
        }
        .player-active-p2 {
            background: rgba(255, 65, 108, 0.3) !important;
            border-color: #ff416c !important;
            box-shadow: 0 0 20px rgba(255, 65, 108, 0.5);
            animation: glow-p2 1.5s infinite alternate;
        }

        @keyframes glow-p1 {
            from { box-shadow: 0 0 10px rgba(0, 210, 255, 0.3); transform: scale(1); }
            to { box-shadow: 0 0 25px rgba(0, 210, 255, 0.6); transform: scale(1.02); }
        }
        @keyframes glow-p2 {
            from { box-shadow: 0 0 10px rgba(255, 65, 108, 0.3); transform: scale(1); }
            to { box-shadow: 0 0 25px rgba(255, 65, 108, 0.6); transform: scale(1.02); }
        }

        .p1-turn-active { border-color: #00d2ff; box-shadow: 0 0 10px rgba(0, 210, 255, 0.3); background: rgba(0, 210, 255, 0.05); }
        .p2-turn-active { border-color: #ff416c; box-shadow: 0 0 10px rgba(255, 65, 108, 0.3); background: rgba(255, 65, 108, 0.05); }

        .timer-bar-fill { height: 100%; background: #00ff88; width: 100%; transition: width 0.1s linear; }

        @keyframes pop-emoji {
            0% { transform: translate(-50%, 0) scale(0); opacity: 0; }
            50% { transform: translate(-50%, -60px) scale(2); opacity: 1; }
            100% { transform: translate(-50%, -100px) scale(1); opacity: 0; }
        }

        .emoji-popup {
            position: absolute;
            left: 50%;
            top: 40%;
            pointer-events: none;
            z-index: 200;
            font-size: 3rem;
            animation: pop-emoji 1s ease-out forwards;
        }

        .prog-bar-container {
            height: 4px;
            background: rgba(255,255,255,0.05);
            width: 100%;
            position: fixed;
            bottom: 0;
            left: 0;
            z-index: 50;
        }
        #game-prog-fill {
            height: 100%;
            background: linear-gradient(to right, #00d2ff, #ff416c);
            width: 0%;
            transition: width 0.5s ease;
        }

        .set-soal-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #888;
            transition: all 0.3s;
            padding: 10px 4px;
            font-size: 9px;
            border-radius: 8px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .set-soal-btn.active {
            background: rgba(0, 210, 255, 0.2);
            border-color: #00d2ff;
            color: #fff;
            box-shadow: 0 0 15px rgba(0, 210, 255, 0.3);
        }

        @media (max-width: 640px) {
            #question-text { font-size: 0.95rem; }
            .choice-btn { padding: 8px; font-size: 0.75rem; min-height: 42px; }
            .cyber-card { padding: 1rem !important; }
        }
    </style>
</head>
<body>

<header class="global-header">
    <h2 class="text-xs md:text-lg text-cyan-400 font-bold uppercase tracking-widest">SMK Merah Putih School Metro</h2>
    <div class="flex justify-center gap-x-4 mt-1 text-[7px] md:text-[9px] font-bold tracking-[0.2em] text-gray-400">
        <span>PROJEK IPAS</span>
        <span>MS LINA MARWATI</span>
    </div>
</header>

<main id="game-container" class="flex-grow flex flex-col relative overflow-hidden">
    
    <div id="audio-overlay" class="absolute inset-0 z-[200] bg-black flex flex-col items-center justify-center text-center p-6">
        <div class="cyber-card p-8 border-cyan-500/50 max-w-sm">
            <div class="mb-4 text-4xl animate-bounce">‚ö°</div>
            <h2 class="text-xl font-black mb-2 text-white uppercase italic tracking-tighter">Battle Ready?</h2>
            <p class="text-[9px] text-cyan-400 mb-6 font-bold uppercase tracking-[0.3em]">Musik Energik Siap Dimainkan!</p>
            <button onclick="startEverything()" class="w-full py-4 bg-cyan-600 hover:bg-cyan-400 text-black font-black rounded-full shadow-[0_0_30px_rgba(0,210,255,0.4)] transition-all uppercase text-[10px] tracking-widest">
                AKTIFKAN MUSIK & BATTLE
            </button>
        </div>
    </div>

    <div id="setup-screen" class="hidden absolute inset-0 z-50 flex items-center justify-center p-4 bg-[#020205]">
        <div class="cyber-card p-5 max-w-lg w-full text-center overflow-y-auto max-h-full">
            <h1 class="text-base font-black text-white mb-3 uppercase italic tracking-widest border-b border-white/10 pb-2">Konfigurasi Game</h1>
            
            <div class="space-y-4">
                <div id="leaderboard-section" class="p-2 bg-white/5 rounded-xl border border-cyan-500/20">
                    <div class="flex justify-between items-center mb-1">
                        <p class="text-[8px] text-cyan-400 font-bold uppercase">Top Winner</p>
                        <button onclick="loadLeaderboard()" class="text-[7px] text-gray-400 hover:text-white uppercase">Refresh</button>
                    </div>
                    <div id="global-leaderboard" class="space-y-1">
                        <p class="text-[8px] text-gray-500 italic">Memuat...</p>
                    </div>
                </div>

                <div class="text-left">
                    <label class="text-[8px] text-cyan-400 font-bold ml-1 mb-2 block uppercase italic">Pilih Paket Soal (Campuran)</label>
                    <div class="grid grid-cols-5 gap-2">
                        <button onclick="selectSet('set1')" id="btn-set-set1" class="set-soal-btn active">SET 1</button>
                        <button onclick="selectSet('set2')" id="btn-set-set2" class="set-soal-btn">SET 2</button>
                        <button onclick="selectSet('set3')" id="btn-set-set3" class="set-soal-btn">SET 3</button>
                        <button onclick="selectSet('set4')" id="btn-set-set4" class="set-soal-btn">SET 4</button>
                        <button onclick="selectSet('set5')" id="btn-set-set5" class="set-soal-btn">SET 5</button>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div class="text-left">
                        <label class="text-[8px] text-cyan-400 font-bold ml-1 mb-1 block uppercase">Player 1</label>
                        <input type="text" id="p1-name-input" maxlength="10" placeholder="SINGA" class="w-full p-2 bg-white/5 border border-cyan-500/30 rounded-lg text-center text-[10px] text-white uppercase outline-none focus:border-cyan-400">
                    </div>
                    <div class="text-left">
                        <label class="text-[8px] text-rose-400 font-bold ml-1 mb-1 block uppercase">Player 2</label>
                        <input type="text" id="p2-name-input" maxlength="10" placeholder="MACAN" class="w-full p-2 bg-white/5 border border-rose-500/30 rounded-lg text-center text-[10px] text-white uppercase outline-none focus:border-rose-400">
                    </div>
                </div>

                <button onclick="initBattle()" class="w-full py-4 bg-white text-black font-black text-xs rounded-xl uppercase tracking-[0.2em] hover:bg-cyan-400 transition-all shadow-lg">
                    MULAI PERTANDINGAN
                </button>
            </div>
        </div>
    </div>

    <div id="battle-screen" class="hidden flex-grow flex flex-col p-3 md:p-6 relative overflow-hidden">
        <div class="flex justify-between items-start mb-4">
            <div id="p1-card" class="bg-cyan-900/20 p-2 rounded-lg border border-cyan-500/30 min-w-[80px] transition-all duration-300">
                <h3 id="p1-display" class="text-[10px] font-bold text-cyan-400 uppercase">P1</h3>
                <div id="p1-score" class="text-xs font-black text-white">POIN: 0</div>
                <div id="p1-indicator" class="text-[8px] font-black text-gray-500 mt-1 uppercase">Siaga</div>
            </div>
            
            <div class="text-center">
                <div class="text-3xl font-black text-white italic leading-none" id="main-timer">15</div>
                <div id="question-counter" class="text-[8px] text-gray-500 uppercase font-bold tracking-[0.2em] mt-1">SOAL 1/10</div>
            </div>

            <div id="p2-card" class="bg-rose-900/20 p-2 rounded-lg border border-rose-500/30 text-right min-w-[80px] transition-all duration-300">
                <h3 id="p2-display" class="text-[10px] font-bold text-rose-500 uppercase">P2</h3>
                <div id="p2-score" class="text-xs font-black text-white">POIN: 0</div>
                <div id="p2-indicator" class="text-[8px] font-black text-gray-500 mt-1 uppercase">Siaga</div>
            </div>
        </div>

        <div class="mb-4">
            <div class="rope-container">
                <div id="p1-pull" class="p1-side" style="width: 50%;"></div>
                <div id="p2-pull" class="p2-side" style="width: 50%;"></div>
                <div id="rope-marker" style="left: 50%;"></div>
            </div>
        </div>

        <div class="flex-grow flex flex-col justify-center max-w-xl mx-auto w-full overflow-hidden">
            <div class="h-1 bg-white/10 mb-4 overflow-hidden rounded-full">
                <div class="timer-bar-fill" id="timer-bar"></div>
            </div>
            
            <div class="cyber-card p-4 md:p-8 relative flex flex-col min-h-[220px] justify-center">
                <div id="emoji-container" class="absolute inset-0 pointer-events-none"></div>
                <div class="text-center mb-4">
                    <p id="turn-announcement" class="text-[8px] font-black uppercase tracking-[0.3em] mb-2 text-cyan-400">SIAP-SIAP!</p>
                    <h2 id="question-text" class="text-sm md:text-xl font-bold leading-snug text-white">---</h2>
                </div>
                
                <div id="options-grid" class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                    <button onclick="submitAnswer(0)" id="opt-0" class="choice-btn font-bold text-white hover:border-cyan-500">---</button>
                    <button onclick="submitAnswer(1)" id="opt-1" class="choice-btn font-bold text-white hover:border-cyan-500">---</button>
                    <button onclick="submitAnswer(2)" id="opt-2" class="choice-btn font-bold text-white hover:border-cyan-500">---</button>
                    <button onclick="submitAnswer(3)" id="opt-3" class="choice-btn font-bold text-white hover:border-cyan-500">---</button>
                </div>
            </div>
        </div>
    </div>

    <div id="result-screen" class="hidden absolute inset-0 z-[100] bg-black/95 flex items-center justify-center p-6">
        <div class="cyber-card p-10 max-w-sm w-full text-center">
            <div class="text-5xl mb-4">üèÜ</div>
            <h1 class="text-2xl font-black mb-1 text-yellow-400 uppercase italic">SANG JUARA!</h1>
            <p id="winner-name" class="text-lg mb-2 text-white font-bold uppercase tracking-widest">---</p>
            <p id="final-stats" class="text-[10px] text-gray-400 mb-8 uppercase">Skor: 0 vs 0</p>
            <button onclick="location.reload()" class="w-full py-4 bg-white text-black font-black rounded-xl text-[10px] uppercase tracking-[0.2em]">KEMBALI KE MENU</button>
        </div>
    </div>

    <div class="prog-bar-container">
        <div id="game-prog-fill"></div>
    </div>

</main>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, doc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Data Soal Campuran (Mix)
    const questionSets = {
        set1: [
            { q: "Apa nama pelabuhan feri utama di Lampung?", options: ["Panjang", "Bakauheni", "Kalianda", "Maringgai"], a: 1 },
            { q: "Logistik dalam ekonomi berkaitan dengan...", options: ["Menabung", "Distribusi barang", "Mencari kerja", "Kurs mata uang"], a: 1 },
            { q: "Lampung terletak di ujung selatan pulau...", options: ["Jawa", "Sumatera", "Kalimantan", "Sulawesi"], a: 1 },
            { q: "Infrastruktur transportasi udara disebut...", options: ["Terminal", "Bandara", "Pelabuhan", "Stasiun"], a: 1 },
            { q: "Peningkatan nilai tambah produk disebut...", options: ["Konsumsi", "Produksi", "Distribusi", "Investasi"], a: 1 },
            { q: "Bandara internasional di Lampung adalah...", options: ["Radin Inten II", "Gatot Subroto", "Taufiq Kiemas", "Silampari"], a: 0 },
            { q: "Salah satu komoditas ekspor terbesar Lampung adalah...", options: ["Gandum", "Kopi & Nanas", "Apel", "Padi"], a: 1 },
            { q: "Selat yang memisahkan Lampung dan Banten adalah...", options: ["Selat Karimata", "Selat Sunda", "Selat Malaka", "Selat Bali"], a: 1 },
            { q: "Infrastruktur pengatur air sawah disebut...", options: ["Tol", "Irigasi", "Jembatan", "Rel"], a: 1 },
            { q: "Pasar yang transaksinya lewat HP disebut...", options: ["Pasar Tradisional", "E-Commerce", "Pasar Kaget", "Barter"], a: 1 }
        ],
        set2: [
            { q: "Apa kegunaan utama Jalan Tol Trans Sumatera?", options: ["Hiasan jalan", "Mempercepat logistik", "Tempat balapan", "Lahan parkir"], a: 1 },
            { q: "Hub (Pusat) distribusi barang biasanya berada di...", options: ["Puncak Gunung", "Dekat Pelabuhan/Tol", "Tengah Hutan", "Desa Terpencil"], a: 1 },
            { q: "Gunung tertinggi di Lampung adalah...", options: ["Gunung Rajabasa", "Gunung Pesagi", "Gunung Tanggamus", "Gunung Krakatau"], a: 1 },
            { q: "Salah satu tol terpanjang di Lampung adalah ruas...", options: ["Metro-Liwa", "Bakauheni-Terbanggi Besar", "Kalianda-Panjang", "Kotabumi-Palembang"], a: 1 },
            { q: "UMKM adalah singkatan dari Usaha...", options: ["Maju Kecil", "Mikro Kecil Menengah", "Muda Kreatif Mandiri", "Milik Keluarga Muda"], a: 1 },
            { q: "Konektivitas antar wilayah berarti...", options: ["Saling terhubung", "Saling memisah", "Saling bersaing", "Saling diam"], a: 0 },
            { q: "Apa itu Supply Chain?", options: ["Rantai Pasok", "Rantai Besi", "Sistem Perbankan", "Jaringan Listrik"], a: 0 },
            { q: "Ibukota provinsi Lampung adalah...", options: ["Metro", "Bandar Lampung", "Pringsewu", "Liwa"], a: 1 },
            { q: "Fungsi utama terminal adalah tempat...", options: ["Naik-turun penumpang", "Parkir pribadi", "Jualan mobil", "Pusat pemerintahan"], a: 0 },
            { q: "Promosi produk secara digital dilakukan lewat...", options: ["Spanduk", "Media Sosial", "Keliling", "Brosur"], a: 1 }
        ],
        set3: [
            { q: "Contoh hubungan non-fisik antar wilayah adalah...", options: ["Jembatan", "Internet", "Jalan Raya", "Rel Kereta"], a: 1 },
            { q: "Masalah logistik paling umum di Indonesia adalah...", options: ["Barang terlalu banyak", "Biaya pengiriman mahal", "Peminat sedikit", "Tidak ada barang"], a: 1 },
            { q: "Taman Nasional terkenal dengan gajah di Lampung...", options: ["Way Kambas", "Ujung Kulon", "Bukit Barisan", "Kerinci"], a: 0 },
            { q: "Pembangunan jalan beton lebih tahan lama dibanding...", options: ["Aspal", "Batu kali", "Pasir", "Tanah liat"], a: 0 },
            { q: "Tujuan perdagangan antar wilayah adalah...", options: ["Mencari musuh", "Memenuhi kebutuhan", "Memamerkan harta", "Menghabiskan barang"], a: 1 },
            { q: "Dampak buruk wilayah terisolasi adalah...", options: ["Harga murah", "Ekonomi tidak merata", "Akses mudah", "Pembangunan cepat"], a: 1 },
            { q: "Transportasi air paling efektif untuk barang seberat...", options: ["1 Kg", "Ribuan Ton", "10 Kg", "50 Kg"], a: 1 },
            { q: "Pantai terkenal untuk selancar di Pesisir Barat...", options: ["Mutun", "Tanjung Setia", "Pasir Putih", "Sari Ringgit"], a: 1 },
            { q: "Infrastruktur digital utama adalah jaringan...", options: ["Pipa Air", "Internet & Fiber Optik", "Kabel Listrik", "Rel Kereta"], a: 1 },
            { q: "Mata uang resmi Indonesia adalah...", options: ["Ringgit", "Rupiah", "Dolar", "Yen"], a: 1 }
        ],
        set4: [
            { q: "Menara Siger adalah simbol gerbang masuk...", options: ["Bengkulu", "Lampung", "Palembang", "Jambi"], a: 1 },
            { q: "Gudang penyimpanan dalam logistik disebut...", options: ["Showroom", "Warehouse", "Outlet", "Workshop"], a: 1 },
            { q: "Sungai terpanjang di Lampung adalah...", options: ["Way Sekampung", "Way Tulang Bawang", "Way Mesuji", "Way Seputih"], a: 1 },
            { q: "Jembatan berfungsi utama untuk...", options: ["Memperindah kota", "Memperlancar arus kendaraan", "Tempat memancing", "Lahan iklan"], a: 1 },
            { q: "Kegiatan memakai barang hasil produksi disebut...", options: ["Investasi", "Konsumsi", "Distribusi", "Promosi"], a: 1 },
            { q: "Stasiun KA pusat di Bandar Lampung adalah...", options: ["Tanjung Karang", "Kotabumi", "Rejosari", "Metro"], a: 0 },
            { q: "Manajemen logistik bertujuan meminimalkan...", options: ["Kualitas", "Biaya & Waktu", "Keuntungan", "Jumlah barang"], a: 1 },
            { q: "Lampung berbatasan di utara dengan...", options: ["Bengkulu & Sumsel", "Jambi", "Riau", "Banten"], a: 0 },
            { q: "Pembangkit listrik di Lampung menggunakan energi...", options: ["Nuklir", "Air & Panas Bumi", "Angin", "Ombak"], a: 1 },
            { q: "Pajak adalah salah satu sumber pendapatan...", options: ["Pribadi", "Negara", "Sekolah", "Toko"], a: 1 }
        ],
        set5: [
            { q: "Integrasi transportasi bertujuan agar...", options: ["Tiket mahal", "Efisien & Terhubung", "Waktu lama", "Jalan macet"], a: 1 },
            { q: "Barang cepat rusak (perishable) dikirim via...", options: ["Kapal Laut", "Pesawat Udara", "Sepeda", "Gerobak"], a: 1 },
            { q: "Kota Metro dikenal sebagai kota...", options: ["Industri", "Pendidikan", "Pertambangan", "Pelabuhan"], a: 1 },
            { q: "Fasilitas kesehatan tingkat pertama adalah...", options: ["Rumah Sakit Umum", "Puskesmas", "Apotek", "Laboratorium"], a: 1 },
            { q: "Inflasi berarti kenaikan harga secara...", options: ["Sesaat", "Terus menerus", "Rahasia", "Menurun"], a: 1 },
            { q: "Tujuan utama pembangunan pelabuhan internasional?", options: ["Wisata", "Ekspor-Impor", "Pemancingan", "Lahan reklamasi"], a: 1 },
            { q: "Label 'Fragile' pada paket logistik berarti...", options: ["Barang Murah", "Mudah Pecah", "Anti Air", "Bisa Dimakan"], a: 1 },
            { q: "Pulau kecil indah di Teluk Lampung adalah...", options: ["Bali", "Pahawang", "Seribu", "Madura"], a: 1 },
            { q: "Penyediaan air bersih kota dikelola oleh...", options: ["PLN", "PDAM", "PT KAI", "Bulog"], a: 1 },
            { q: "Tempat bertemunya penjual dan pembeli disebut...", options: ["Kantor", "Pasar", "Sekolah", "Gudang"], a: 1 }
        ]
    };

    const appId = typeof __app_id !== 'undefined' ? __app_id : 'smk-tug-v7';
    let db, auth, user;
    let audioCtx;
    let musicInterval;
    
    let state = {
        currentSet: 'set1',
        questions: [],
        currentIndex: 0,
        ropePos: 50,
        currentPlayer: 1,
        p1Score: 0,
        p2Score: 0,
        timer: 15,
        timerInt: null,
        isGameOver: false
    };

    window.loadLeaderboard = async () => {
        if (!db || !user) return;
        const container = document.getElementById('global-leaderboard');
        container.innerHTML = "<p class='text-[8px] text-gray-500 italic animate-pulse'>Memperbarui...</p>";
        
        try {
            const snap = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'scores'));
            const counts = {};
            snap.forEach(d => { 
                const data = d.data();
                if(data.winner && data.winner !== "SERI") {
                    counts[data.winner] = (counts[data.winner] || 0) + 1; 
                }
            });
            const top = Object.entries(counts).sort((a,b) => b[1]-a[1]).slice(0, 5);
            
            container.innerHTML = top.length ? top.map((t, idx) => `
                <div class="flex justify-between items-center text-[8px] px-2 py-1.5 bg-white/5 rounded border-l-2 ${idx === 0 ? 'border-yellow-500' : 'border-cyan-500/30'}">
                    <span class="text-white font-bold">${idx + 1}. ${t[0]}</span>
                    <span class="text-cyan-400 font-black">${t[1]} WIN</span>
                </div>
            `).join('') : "<p class='text-[8px] text-gray-500'>Belum ada rekor.</p>";
        } catch (e) {
            console.error(e);
            container.innerHTML = "<p class='text-[8px] text-rose-400'>Gagal memuat data.</p>";
        }
    };

    window.selectSet = (setName) => {
        state.currentSet = setName;
        document.querySelectorAll('.set-soal-btn').forEach(btn => btn.classList.remove('active'));
        document.getElementById(`btn-set-${setName}`).classList.add('active');
        playSfx(600, 'triangle', 0.1);
    };

    function playBGM() {
        if (!audioCtx) return;
        const scale = [110, 130.81, 146.83, 164.81, 196.00];
        let step = 0;
        musicInterval = setInterval(() => {
            const time = audioCtx.currentTime;
            if (step % 4 === 0) {
                const kick = audioCtx.createOscillator();
                const kg = audioCtx.createGain();
                kick.frequency.setValueAtTime(150, time);
                kick.frequency.exponentialRampToValueAtTime(0.01, time + 0.5);
                kg.gain.setValueAtTime(0.1, time);
                kg.gain.exponentialRampToValueAtTime(0.01, time + 0.5);
                kick.connect(kg);
                kg.connect(audioCtx.destination);
                kick.start();
                kick.stop(time + 0.5);
            }
            const freq = scale[Math.floor(Math.random() * scale.length)];
            const osc = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            osc.type = step % 8 < 4 ? 'sawtooth' : 'square';
            osc.frequency.setValueAtTime(freq * (step % 2 === 0 ? 2 : 1), time);
            g.gain.setValueAtTime(0.02, time);
            g.gain.exponentialRampToValueAtTime(0.001, time + 0.2);
            osc.connect(g);
            g.connect(audioCtx.destination);
            osc.start();
            osc.stop(time + 0.25);
            step++;
        }, 150);
    }

    function playSfx(freq, type = 'sine', dur = 0.2, vol = 0.1) {
        if (!audioCtx) return;
        const osc = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        osc.type = type;
        osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
        g.gain.setValueAtTime(vol, audioCtx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + dur);
        osc.connect(g);
        g.connect(audioCtx.destination);
        osc.start();
        osc.stop(audioCtx.currentTime + dur);
    }

    window.startEverything = () => {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        playBGM();
        document.getElementById('audio-overlay').classList.add('hidden');
        document.getElementById('setup-screen').classList.remove('hidden');
    };

    window.initBattle = () => {
        const p1 = document.getElementById('p1-name-input').value.toUpperCase() || "SINGA";
        const p2 = document.getElementById('p2-name-input').value.toUpperCase() || "MACAN";
        
        state.p1Name = p1;
        state.p2Name = p2;
        state.questions = questionSets[state.currentSet];
        state.currentIndex = 0;
        state.ropePos = 50;
        state.p1Score = 0;
        state.p2Score = 0;
        state.isGameOver = false;
        
        document.getElementById('p1-display').innerText = p1;
        document.getElementById('p2-display').innerText = p2;
        document.getElementById('p1-score').innerText = `POIN: 0`;
        document.getElementById('p2-score').innerText = `POIN: 0`;
        
        document.getElementById('setup-screen').classList.add('hidden');
        document.getElementById('battle-screen').classList.remove('hidden');
        
        renderQuestion();
    };

    function renderQuestion() {
        const qData = state.questions[state.currentIndex];
        document.getElementById('question-text').innerText = qData.q;
        document.getElementById('question-counter').innerText = `SOAL ${state.currentIndex + 1}/${state.questions.length}`;
        
        const turnText = state.currentPlayer === 1 ? state.p1Name : state.p2Name;
        document.getElementById('turn-announcement').innerText = `GILIRAN: ${turnText}`;
        document.getElementById('turn-announcement').style.color = state.currentPlayer === 1 ? "#00d2ff" : "#ff416c";
        
        const p1Card = document.getElementById('p1-card');
        const p2Card = document.getElementById('p2-card');
        
        if (state.currentPlayer === 1) {
            p1Card.classList.add('player-active-p1');
            p2Card.classList.remove('player-active-p2');
        } else {
            p2Card.classList.add('player-active-p2');
            p1Card.classList.remove('player-active-p1');
        }

        const progress = (state.currentIndex / state.questions.length) * 100;
        document.getElementById('game-prog-fill').style.width = progress + "%";

        const grid = document.getElementById('options-grid');
        grid.className = state.currentPlayer === 1 ? "grid grid-cols-1 sm:grid-cols-2 gap-2 p1-turn-active p-1 rounded-xl" : "grid grid-cols-1 sm:grid-cols-2 gap-2 p2-turn-active p-1 rounded-xl";

        for (let i = 0; i < 4; i++) {
            const btn = document.getElementById(`opt-${i}`);
            if (qData.options[i]) {
                btn.innerText = qData.options[i];
                btn.style.display = "flex";
            } else {
                btn.style.display = "none";
            }
        }
        startTimer();
    }

    function startTimer() {
        state.timer = 15;
        clearInterval(state.timerInt);
        state.timerInt = setInterval(() => {
            state.timer -= 0.1;
            document.getElementById('main-timer').innerText = Math.ceil(state.timer);
            document.getElementById('timer-bar').style.width = (state.timer / 15 * 100) + "%";
            if (state.timer <= 0) submitAnswer(-1);
        }, 100);
    }

    window.submitAnswer = (idx) => {
        if (state.isGameOver) return;
        clearInterval(state.timerInt);
        
        const correct = idx === state.questions[state.currentIndex].a;
        spawnEmoji(correct);

        if (correct) {
            playSfx(880, 'sine', 0.2, 0.15);
            if (state.currentPlayer === 1) {
                state.p1Score += 10;
                state.ropePos -= 10;
                document.getElementById('p1-score').innerText = `POIN: ${state.p1Score}`;
            } else {
                state.p2Score += 10;
                state.ropePos += 10;
                document.getElementById('p2-score').innerText = `POIN: ${state.p2Score}`;
            }
        } else {
            playSfx(150, 'sawtooth', 0.4, 0.2);
            state.ropePos += (state.currentPlayer === 1 ? 8 : -8);
        }

        state.ropePos = Math.max(5, Math.min(95, state.ropePos));
        document.getElementById('rope-marker').style.left = state.ropePos + "%";
        document.getElementById('p1-pull').style.width = state.ropePos + "%";
        document.getElementById('p2-pull').style.width = (100 - state.ropePos) + "%";

        state.currentIndex++;
        state.currentPlayer = state.currentPlayer === 1 ? 2 : 1;
        
        setTimeout(() => {
            if (state.currentIndex >= state.questions.length || state.ropePos <= 10 || state.ropePos >= 90) {
                endGame();
            } else {
                renderQuestion();
            }
        }, 800);
    };

    function spawnEmoji(isCorrect) {
        const div = document.createElement('div');
        div.className = 'emoji-popup';
        div.innerText = isCorrect ? '‚ö°' : '‚ùå';
        document.getElementById('emoji-container').appendChild(div);
        setTimeout(() => div.remove(), 1000);
    }

    async function endGame() {
        state.isGameOver = true;
        clearInterval(state.timerInt);
        clearInterval(musicInterval);
        document.getElementById('game-prog-fill').style.width = "100%";
        
        document.getElementById('p1-card').classList.remove('player-active-p1');
        document.getElementById('p2-card').classList.remove('player-active-p2');

        let winner = "SERI";
        if (state.ropePos < 50) winner = state.p1Name;
        else if (state.ropePos > 50) winner = state.p2Name;

        document.getElementById('winner-name').innerText = winner;
        document.getElementById('final-stats').innerText = `${state.p1Name}: ${state.p1Score} | ${state.p2Name}: ${state.p2Score}`;
        document.getElementById('result-screen').classList.remove('hidden');
        playSfx(523.25, 'sine', 1.0, 0.2);

        if (winner !== "SERI" && db && user) {
            try {
                // Pastikan path sesuai aturan Firestore: /artifacts/{appId}/public/data/{collectionName}
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'scores'), {
                    winner: winner,
                    score: Math.max(state.p1Score, state.p2Score),
                    timestamp: Date.now(),
                    userId: user.uid
                });
                await window.loadLeaderboard();
            } catch (e) {
                console.error("Gagal menyimpan skor:", e);
            }
        }
    }

    async function initFirebase() {
        try {
            const firebaseConfig = JSON.parse(__firebase_config);
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            
            // Login sesuai prosedur mandatory
            const initAuth = async () => {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            };
            
            await initAuth();
            
            onAuthStateChanged(auth, (u) => { 
                user = u; 
                if(u) window.loadLeaderboard();
            });
        } catch (e) { 
            console.error("Firebase Init Error:", e);
            document.getElementById('global-leaderboard').innerHTML = "<p class='text-[8px] text-gray-600'>Mode Lokal</p>";
        }
    }

    window.addEventListener('load', initFirebase);
</script>
</body>
</html>